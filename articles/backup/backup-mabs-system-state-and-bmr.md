---
title: Azure 备份服务器可保护系统状态并还原为裸机
description: 使用 Azure 备份服务器可备份系统状态并提供裸机恢复 (BMR) 保护。
author: dcurwin
manager: carmonm
keywords: ''
ms.service: backup
ms.topic: conceptual
ms.date: 05/15/2017
ms.author: dacurwin
ms.openlocfilehash: 12412122ba116eedc592fadc57949f707e52c355
ms.sourcegitcommit: 3877b77e7daae26a5b367a5097b19934eb136350
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/30/2019
ms.locfileid: "68639664"
---
# <a name="back-up-system-state-and-restore-to-bare-metal-with-azure-backup-server"></a>使用 Azure 备份服务器备份系统状态并还原为裸机

Azure 备份服务器可备份系统状态并提供裸机恢复 (BMR) 保护。

*   **系统状态备份**：备份操作系统文件，以便可以在计算机启动时进行恢复，但是系统文件和注册表会丢失。 系统状态备份包括：
    * 域成员：启动文件、COM+ 类注册数据库、注册表
    * 域控制器：Windows Server Active Directory (NTDS)、启动文件、COM+ 类注册数据库、注册表、系统卷 (SYSVOL)
    * 运行群集服务的计算机：群集服务器元数据
    * 运行证书服务的计算机：证书数据
* **裸机备份**：备份操作系统文件和关键卷上的所有数据（用户数据除外）。 根据定义，BMR 备份包括系统状态备份。 它可在计算机无法启动，而你必须恢复所有内容时提供保护。

下表总结了可以备份和恢复的内容。 有关可以使用系统状态和 BMR 进行保护的应用版本的详细信息，请参见 [Azure 备份服务器备份哪些内容？](backup-mabs-protection-matrix.md)。

|备份|问题|从 Azure 备份服务器备份进行恢复|从系统状态备份进行恢复|BMR|
|----------|---------|---------------------------|------------------------------------|-------|
|**文件数据**<br /><br />常规数据备份<br /><br />BMR/系统状态备份|文件数据丢失|Y|N|N|
|**文件数据**<br /><br />文件数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|操作系统丢失或损坏|N|Y|Y|
|**文件数据**<br /><br />文件数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|服务器丢失（数据卷完整）|N|N|Y|
|**文件数据**<br /><br />文件数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|服务器丢失（数据卷丢失）|Y|否|是（BMR，接下来是备份文件数据的常规恢复）|
|**SharePoint 数据**：<br /><br />场数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|站点、列表、列表项、文档丢失|Y|N|N|
|**SharePoint 数据**：<br /><br />场数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|操作系统丢失或损坏|N|Y|Y|
|SharePoint 数据：<br /><br />场数据的 Azure 备份服务器备份<br /><br />BMR/系统状态备份|灾难恢复|N|N|N|
|Windows Server 2012 R2 Hyper-V<br /><br />对 Hyper-V 主机或来宾进行 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|VM 丢失|Y|N|N|
|Hyper-V<br /><br />Hyper-V 主机或来宾的 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|丢失或损坏操作系统|N|Y|Y|
|Hyper-V<br /><br />Hyper-V 主机或来宾的 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|Hyper-V 主机丢失（VM 完整）|N|N|Y|
|Hyper-V<br /><br />Hyper-V 主机或来宾的 Azure 备份服务器备份<br /><br />主机的 BMR/系统状态备份|Hyper-V 主机丢失（VM 丢失）|N|N|Y<br /><br />BMR，接下来是常规 Azure 备份服务器恢复|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|应用数据丢失|Y|N|N|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|操作系统丢失或损坏|N|y|Y|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|服务器丢失（数据库/事务日志完整）|N|N|Y|
|SQL Server/Exchange<br /><br />Azure 备份服务器应用备份<br /><br />BMR/系统状态备份|服务器丢失（数据库/事务日志丢失）|N|N|Y<br /><br />BMR 恢复，接下来是常规 Azure 备份服务器恢复|

## <a name="how-system-state-backup-works"></a>系统状态备份的工作方式

系统状态备份运行时，备份服务器会与 Windows Server 备份进行通信以请求进行服务器系统状态备份。 默认情况下，备份服务器和 Windows Server 备份使用具有最多可用空闲空间的驱动器。 有关此驱动器的信息保存在 PSDataSourceConfig.xml 文件中。 这是 Windows Server 备份用于备份的驱动器。

可以自定义备份服务器用于进行系统状态备份的驱动器。 在受保护服务器上，转到 C:\Program Files\Microsoft Data Protection Manager\MABS\Datasources。 打开 PSDataSourceConfig.xml 文件进行编辑。 更改驱动器号的 \<FilesToProtect\> 值。 保存并关闭该文件。 如果没有设置为保护计算机系统状态的保护组，则运行一致性检查。 如果生成警报，则在警报中选择“修改保护组”，然后完成向导。 然后，运行另一次一致性检查。

请注意，如果保护服务器处于群集中，则可能会选择群集驱动器作为具有最多可用空间的驱动器。 如果该驱动器所有权已切换到其他节点并且系统状态备份在运行，则该驱动器不可用，备份会失败。 在此情景中，修改 PSDataSourceConfig.xml 以指向本地驱动器。

接下来，Windows Server 备份会在还原文件夹的根目录中创建名为 WindowsImageBackup 的文件夹。 Windows Server 备份创建备份时，所有数据都会置于此文件夹中。 备份完成时，文件会传输到备份服务器计算机。 请注意以下信息：

* 在备份或传输完成时，不清理此文件夹及其内容。 考虑这一点的最佳方法是将空间保留到下次备份完成时。
* 每次进行备份时都会创建文件夹。 时间和日期戳反映上次系统状态备份的时间。

## <a name="bmr-backup"></a>BMR 备份

对于 BMR（包括系统状态备份），备份作业会直接保存到备份服务器计算机上的共享中。 它不会保存到受保护服务器上的文件夹中。

备份服务器会调用 Windows Server 备份，并共享副本卷以用于该 BMR 备份。 在这种情况下，它不会告知 Windows Server 备份使用具有最多可用空间的驱动器。 而是使用为作业创建的共享。

备份完成时，文件会传输到备份服务器计算机。 日志存储在 C:\Windows\Logs\WindowsServerBackup 中。

## <a name="prerequisites-and-limitations"></a>先决条件和限制

-   运行 Windows Server 2003 的计算机或运行客户端操作系统的计算机不支持 BMR。

-   无法在不同保护组中为相同计算机保护 BMR 和系统状态。

-   备份服务器计算机无法保护自己以进行 BMR。

-   BMR 不支持到磁带（磁盘到磁带，或 D2T）的短期保护。 支持到磁带（磁盘到磁盘到磁带，或 D2D2T）的长期存储。

-   对于 BMR 保护，必须在受保护计算机上安装 Windows Server 备份。

-   对于 BMR 保护，与系统状态保护不同，备份服务器对受保护计算机没有任何空间要求。 Windows Server 备份会将备份直接传输到备份服务器计算机。 备份传输作业不会出现在备份服务器“作业”视图中。

-   备份服务器会在副本卷上保留 30 GB 空间以用于 BMR。 可以在“修改保护组”向导中的“磁盘分配”页上，或使用 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell cmdlet 对此进行更改。 在恢复点卷上，BMR 保护在五天保留期内需要大约 6 GB。
    * 请注意，不能将副本卷大小减少到小于 15 GB。
    * 备份服务器不会计算 BMR 数据源的大小。 它假定对所有服务器都使用 30 GB。 可基于在环境中期望的 BMR 备份大小更改该值。 BMR 备份的大小可以大致计算为所有关键卷上的已用空间总和。 关键卷 = 引导卷 + 系统卷 + 承载系统状态数据的卷（如 Active Directory）。

-   如果从系统状态保护更改为 BMR 保护，则 BMR 保护在恢复点卷上需要较少的空间。 但是，不会回收卷上的额外空间。 可以在“修改保护组”向导的“修改磁盘分配”页上，或使用 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell cmdlet 手动缩小卷大小。

    如果从系统状态保护更改为 BMR 保护，则 BMR 保护在副本卷上需要较多的空间。 该卷会自动扩展。 如果要更改默认空间分配，请使用 Modify-DiskAllocation PowerShell cmdlet。

-   如果从 BMR 保护更改为系统状态保护，则在恢复点卷上需要较多的空间。 备份服务器可能会尝试自动增大该卷。 如果存储池中没有足够的空间，则会发生错误。

    如果从 BMR 保护更改为系统状态保护，则在受保护计算机上需要空间。 这是因为系统状态保护首先将副本写入本地计算机，然后将它传输到备份服务器计算机。

## <a name="before-you-begin"></a>开始之前

1.  **部分 Azure 备份服务器**。 验证是否正确部署了备份服务器。 有关详细信息，请参阅：
    * [Azure 备份服务器的系统要求](https://docs.microsoft.com/system-center/dpm/install-dpm#setup-prerequisites)
    * [备份服务器保护矩阵](backup-mabs-protection-matrix.md)

2.  **设置存储**。 可以将备份数据存储在磁盘上、磁带上和使用 Azure 的云中。 有关详细信息，请参阅[准备数据存储](https://docs.microsoft.com/system-center/dpm/plan-long-and-short-term-data-storage)。

3.  **设置保护代理**。 在要备份的计算机上安装保护代理。 有关详细信息，请参阅[部署 DPM 保护代理](https://docs.microsoft.com/system-center/dpm/deploy-dpm-protection-agent)。

## <a name="back-up-system-state-and-bare-metal"></a>备份系统状态和裸机
按[部署保护组](https://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)中所述设置保护组。 请注意，无法在不同组中为相同计算机保护 BMR 和系统状态。 此外在选择 BMR 时，系统状态会自动启用。


1.  若要在备份服务器管理员控制台中打开“创建新保护组”向导，请选择“保护” > “操作” > “创建保护组”。

2.  在“选择保护组类型”页上，选择“服务器”，然后选择“下一步”。

3.  在“选择组成员”页上，展开计算机，然后选择“BMR”或“系统状态”。

    请记住，无法在不同组中为相同计算机保护 BMR 和系统状态。 此外在选择 BMR 时，系统状态会自动启用。 有关详细信息，请参阅[部署保护组](https://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)。

4.  在“选择数据保护方法”页上，选择要用于处理短期和长期备份的方式。 短期备份始终是磁盘优先，可以选择使用 Azure 备份从磁盘备份到 Azure 云（短期或长期）。 长期备份到云的替代方法是设置为长期备份到与备份服务器连接的独立磁带设备或磁带库。

5.  在“选择短期目标”页上，选择要如何备份到磁盘上的短期存储：
    1. 对于“保持期”，选择要在磁盘上保留数据的时间长度。 
    2. 对于“同步频率”，选择要对磁盘运行增量备份的频率。 如果不想设置备份间隔，则可以选中“恰好在恢复点之前”选项。 备份服务器会恰好在计划每个恢复点之前运行快速完整备份。

6.  如果要将数据存储在磁带上以进行长期存储，则在“指定长期目标”页上，选择要保留磁带数据的时间长度（1-99 年）。 
    1. 有关**称繵瞯**，应运行选择何种频率备份到磁带。 频率取决于选择的保持期：
        * 保持期是 1-99 年时，可以选择每天、每周、每两周、每月、每季度、每半年或每年进行备份。
        * 保持期是 1-11 个月时，可以选择每天、每周、每两周或每月进行备份。
        * 保持期是 1-4 周时，可以选择每天或每周进行备份。

    2. 在“选择磁带和库详细信息”页上，选择要使用的磁带和库以及是否应对数据进行压缩和加密。

7.  在“检查磁盘分配”页上，检查为保护组分配的存储池磁盘空间。

    1. “总数据大小”是要备份的数据的大小。
    2. “要在 Azure 备份服务器上设置的磁盘空间”是备份服务器为保护组推荐的空间。 备份服务器基于设置选择理想备份卷。 但是，可以在“磁盘分配详细信息”中编辑备份卷选项。 
    3. 对于工作负载，在下拉菜单中选择首选存储。 编辑会更改“可用磁盘存储”窗格中的“存储总量”和“可用存储”值。 设置不足的空间是备份服务器建议添加到卷以确保备份平稳的存储量。

8.  在“选择副本创建方法”页上，选择要如何处理初始完整数据复制。 如果选择通过网络复制，则建议选择非高峰时间。 如果数据量很大或者网络状态欠佳，请考虑使用可移动介质脱机复制数据。

9. 在“选择一致性检查选项”页上，选择要如何自动执行一致性检查。 可以选择在副本数据变得不一致时或按照计划运行检查。 如果不想配置自动一致性检查，可以随时运行手动检查。 要运行手动检查，请在备份服务器管理员控制台的“保护”区域中，右键单击保护组，然后选择“执行一致性检查”。

10. 如果选择使用 Azure 备份来备份到云，则在“指定在线保护数据”页上，确保选择要备份到 Azure 的工作负载。

11. 在“指定联机备份计划”页上，选择增量备份到 Azure 的频率。 可以将备份计划为每天、每周、每月和每年运行，并选择应运行它们的时间和日期。 备份一天最多可以进行两次。 每次备份运行时，会通过备份服务器磁盘上存储的备份数据的副本在 Azure 中创建数据恢复点。

12. 在“指定联机保留策略”页上，选择如何在 Azure 中保留通过每天、每周、每月和每年备份创建的恢复点。

13. 在“选择联机复制”页上，选择如何进行数据的初始完整复制。 可以通过网络复制，也可以执行脱机备份（脱机设定种子）。 脱机备份使用 Azure 导入功能。 有关详细信息，请参阅 [Azure 备份中的脱机备份工作流](backup-azure-backup-import-export.md)。

14. 在“摘要”页上，检查设置。 选择“创建组”之后，进行数据的初始复制。 数据复制完成后，在“状态”页上，保护组状态是“正常”。 备份随后会按照保护组设置进行。

## <a name="recover-system-state-or-bmr"></a>恢复系统状态或 BMR
可以将 BMR 或系统状态恢复到网络位置。 如果备份了 BMR，则使用 Windows 恢复环境 (WinRE) 启动系统并将它连接到网络。 然后使用 Windows Server 备份从网络位置进行恢复。 如果备份了系统状态，则只需使用 Windows Server 备份从网络位置进行恢复。

### <a name="restore-bmr"></a>还原 BMR
在备份服务器计算机上运行恢复：

1.  在“恢复”窗格中，找到要恢复的计算机，然后选择“裸机恢复”。

2.  可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。

3.  在“选择恢复类型”页上，选择“复制到网络文件夹”。

4.  在“指定目标”页上，选择要向其中复制数据的位置。 请记住，所选目标需要具有足够空间。 建议创建新文件夹。

5.  在“指定恢复选项”页上，选择要应用的安全设置。 然后，选择是否要使用基于存储区域网络 (SAN) 的硬件快照实现更快的恢复。 （仅当具有提供此功能的 SAN，并且能够创建和拆分克隆以使其可写时，才可使用此选项。 此外，受保护计算机和备份服务器计算机必须连接到同一网络。）

6.  设置通知选项。 在“确认”页上，选择“恢复”。

设置共享位置：

1.  在还原位置中，转到包含备份的文件夹。

2.  共享比 WindowsImageBackup 高一个级别的文件夹，以便共享文件夹的根目录是 WindowsImageBackup 文件夹。 如果不这样做，还原会找不到备份。 若要使用 Windows 恢复环境 (WinRE) 进行连接，需要可以使用正确的 IP 地址和凭据在 WinRE 中访问的共享。

还原系统：

1.  通过对所还原的系统使用 Windows DVD，启动要在其上还原映像的计算机。

2.  在第一页上，验证语言和区域设置的设置。 在“安装”页上，选择“修复计算机”。

3.  在“系统恢复选项”页上，选择“使用以前创建的系统映像还原计算机”。

4.  在“选择系统镜像备份”页上，选择“选择系统映像” > “高级” > “在网络上搜索系统映像”。 如果出现警告，请选择“是”。 转到共享路径，输入凭据，然后选择恢复点。 这会扫描在该恢复点中可用的特定备份。 选择要使用的恢复点。

5.  在“选择还原备份的方式”页上，选择“格式化并重新分区磁盘”。 在下一步页上，验证设置。 

6.  若要开始还原，请选择“完成”。 需要重新启动。

### <a name="restore-system-state"></a>还原系统状态

在备份服务器中运行恢复：

1.  在“恢复”窗格中，找到要恢复的计算机，然后选择“裸机恢复”。

2.  可用恢复点在日历上以粗体进行指示。 为要使用的恢复点选择日期和时间。

3.  在“选择恢复类型”页上，选择“复制到网络文件夹”。

4.  在“指定目标”页上，选择要向其中复制数据的位置。 请记住，所选目标需要足够空间。 建议创建新文件夹。

5.  在“指定恢复选项”页上，选择要应用的安全设置。 然后，选择是否要使用基于 SAN 的硬件快照实现更快的恢复。 （仅当具有提供此功能的 SAN，并且能够创建和拆分克隆以使其可写时，才可使用此选项。 此外，受保护计算机和备份服务器必须连接到同一网络。）

6.  设置通知选项。 在“确认”页上，选择“恢复”。

运行 Windows Server 备份：

1.  选择“操作” > “恢复” > “此服务器” > “下一步”。

2.  选择“另一台服务器”，选择“指定位置类型”页，然后选择“远程共享文件夹”。 输入包含恢复点的文件夹的路径。

3.  在“选择恢复类型”页上，选择“系统状态”。 

4. 在“选择系统状态恢复的位置”页上，选择“原始位置”。

5.  在“确认”页上，选择“恢复”。 还原之后，重新启动服务器。

6.  还可以在命令提示符处运行系统状态还原。 若要执行此操作，请在要恢复的计算机上启动 Windows Server 备份。 若要获取版本标识符，请在命令提示符处输入：```wbadmin get versions -backuptarget \<servername\sharename\>```

    使用版本标识符启动系统状态还原。 在命令提示符处，输入：```wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\sharename>```

    确认要开始恢复。 可以在命令提示符窗口中查看过程。 会创建还原日志。 还原之后，重新启动服务器。

