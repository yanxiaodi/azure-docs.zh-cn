---
title: 在 VMware VM 和物理服务器的灾难恢复期间，将 VM 从 Azure 重新保护到本地站点 | Microsoft Docs
description: 在 VMware VM 和物理服务器的灾难恢复期间故障转移到 Azure 后，了解如何从 Azure 故障回复到本地站点。
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: conceptual
ms.date: 3/12/2019
ms.author: mayg
ms.openlocfilehash: 4202d95b540efb98b526f8a8abd17da22a908ebe
ms.sourcegitcommit: 41ca82b5f95d2e07b0c7f9025b912daf0ab21909
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 06/13/2019
ms.locfileid: "60482896"
---
# <a name="reprotect-and-fail-back-machines-to-an-on-premises-site-after-failover-to-azure"></a>故障转移到 Azure 后，将计算机重新保护并故障回复到本地站点

将本地 VMware VM 或物理服务器[故障转移](site-recovery-failover.md)到 Azure 后，故障回复到本地站点的第一步是重新保护故障转移期间创建的 Azure VM。 本文介绍如何执行此操作。 

有关快速概述，请观看以下有关如何从 Azure 故障转移到本地站点的视频。<br /><br />
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]


## <a name="before-you-begin"></a>开始之前

如果虚拟机是使用模板创建的，请确保每个虚拟机对于磁盘具有其自己的 UUID。 如果本地虚拟机的 UUID 与主目标的 UUID 冲突（因为两者都是基于同一模板创建的），重新保护会失败。 请部署不是基于同一模板创建的另一个主目标。 请注意以下信息：
- 如果尝试故障回复到备用 vCenter，请确保已发现新 vCenter 和主目标服务器。 一种典型的症状是，数据存储在“重新保护”  对话框中不可访问或不可见。
- 若要复制回本地，需要故障回复策略。 在创建正向策略时，会自动创建此策略。 请注意以下信息：
    - 此策略在创建过程中会与配置服务器自动关联。
    - 此策略不可编辑。
    - 此策略的设置值为（RPO 阈值 = 15 分钟，恢复点保留期 = 24 小时，应用一致性快照频率 = 60 分钟）。
- 在重新保护和故障回复期间，本地配置服务器必须正在运行且已连接。
- 如果 vCenter 服务器管理着要故障回复到的虚拟机，请确保你拥有在 vCenter 服务器上发现 VM [所需的权限](vmware-azure-tutorial-prepare-on-premises.md#prepare-an-account-for-automatic-discovery)。
- 在重新保护之前，请删除主目标服务器上的快照。 如果本地主目标或虚拟机上存在快照，则重新保护会失败。 在执行重新保护作业期间，虚拟机上的快照会自动合并。
- 复制组的所有虚拟机必须都是相同的操作系统类型（全都为 Windows 或全都为 Linux）。 混合操作系统的复制组当前不支持重新保护和故障回复到本地。 这是因为主目标必须与虚拟机使用同一操作系统。 复制组的所有虚拟机必须有相同的主目标。 
- 执行故障回复时，本地需有配置服务器。 故障回复期间，虚拟机必须位于配置服务器数据库中。 否则，故障回复不会成功。 请确保定期计划配置服务器备份。 如果发生灾难，请使用相同的 IP 地址还原服务器，以便故障回复正常工作。
- 重新保护和故障回复需要使用站点到站点 (S2S) VPN 复制数据。 应提供网络，以便 Azure 中已故障转移的虚拟机可以访问 (ping) 本地配置服务器。 还可能需要在已故障转移的虚拟机所在的 Azure 网络中部署进程服务器。 此进程服务器还必须能够与本地配置服务器通信。
- 请确保打开以下端口，以便进行故障转移和故障回复：

    ![用于故障转移和故障回复的端口](./media/vmware-azure-reprotect/failover-failback.png)

- 阅读所有[有关端口和 URL 允许列表的先决条件](vmware-azure-deploy-configuration-server.md#prerequisites)。

## <a name="deploy-a-process-server-in-azure"></a>在 Azure 中部署进程服务器

在故障回复到本地站点之前，可能需要 Azure 中的进程服务器：
- 进程服务器从 Azure 中受保护的虚拟机接收数据，然后将数据发送到本地站点。
- 在进程服务器与受保护虚拟机之间需要配置低延迟网络。 通常，确定是否需要 Azure 中的进程服务器时，需要考虑延迟：
    - 如果已设置了 Azure ExpressRoute 连接，则可以使用本地进程服务器发送数据，因为虚拟机与进程服务器之间的延迟较低。
    - 但是，如果只有 S2S VPN，则建议在 Azure 中部署进程服务器。
    - 我们建议在故障回复期间使用基于 Azure 的进程服务器。 如果进程服务器离复制虚拟机（Azure 中进行故障转移的计算机）较近，则复制性能较高。 如需概念证明，可以将本地进程服务器与 ExpressRoute 一起用于专用对等互连。

若要在 Azure 中部署进程服务器，请执行以下操作：

1. 如果需要在 Azure 中部署进程服务器，请参阅[在 Azure 中设置用于故障回复的进程服务器](vmware-azure-set-up-process-server-azure.md)。
2. Azure VM 会向进程服务器发送复制数据。 配置网络，以便 Azure VM 能够访问进程服务器。
3. 请记住，从 Azure 复制到本地的操作只能通过 S2S VPN 或 ExpressRoute 网络的专用对等互连进行。 请确保通过该网络通道提供足够的带宽。

## <a name="deploy-a-separate-master-target-server"></a>部署单独的主目标服务器

主目标服务器接收故障回复数据。 默认情况下，主目标服务器在本地配置服务器上运行。 但是，可能需要创建单独的故障回复用主目标服务器，具体取决于故障回复流量。 下面介绍如何创建主目标服务器：

* [创建 Linux 主目标服务器](vmware-azure-install-linux-master-target.md)以便故障回复 Linux VM。 这是必填字段。 请注意，不支持 LVM 上的主目标服务器。
* （可选）创建单独的主目标服务器用于 Windows VM 故障回复。 为此，请再次运行统一安装程序，并选择创建主目标服务器。 [了解详细信息](site-recovery-plan-capacity-vmware.md#deploy-additional-master-target-servers)。 

创建主目标服务器后，请执行以下任务：

- 如果虚拟机在 vCenter 服务器本地，主目标服务器需要访问本地虚拟机的虚拟机磁盘 (VMDK) 文件。 需要分配向虚拟机磁盘写入复制数据的访问权限。 确保在具有读写访问权限的主目标主机上装载本地虚拟机的数据存储。
- 如果虚拟机不在 vCenter 服务器本地，则 Site Recovery 服务需要在重新保护过程中创建新的虚拟机。 将在你创建主目标的 ESX 主机上创建此虚拟机。 请谨慎选择 ESX 主机，以便将故障回复虚拟机创建在所需的主机上。
- 不能对主目标服务器使用存储 vMotion。 对主目标服务器使用存储 vMotion 可能导致故障回复失败。 虚拟机无法启动，因为磁盘不可供其使用。 若要防止出现此问题，请从 vMotion 列表中排除主目标服务器。
- 如果主目标在重新保护后执行存储 vMotion 任务，则附加到主目标的受保护虚拟机磁盘将迁移到 vMotion 任务的目标。 如果尝试在此之后进行故障回复，则磁盘分离会因为找不到磁盘而失败。 此后，将难以在存储帐户中找到磁盘。 需要手动查找磁盘，并将它们附加到虚拟机。 在此之后，可以启动本地虚拟机。
- 向现有的 Windows 主目标服务器添加一个保留驱动器。 添加新磁盘并格式化驱动器。 保留驱动器用于停止虚拟机复制回本地站点的时间点。 下面是保留驱动器的一些条件。 如果不满足这些条件，则无法为主目标服务器列出驱动器：
    - 卷没有用于任何其他目的，例如用作复制目标。
    - 卷没有处于锁定模式。
    - 卷不是缓存卷。 该卷上不能存在主目标安装。 用于进程服务器和主目标的自定义安装卷不能用作保留卷。 当进程服务器和主目标安装在某个卷上时，该卷是主目标的缓存卷。
    - 卷的文件系统类型不是 FAT 或 FAT32。
    - 卷容量为非零值。
    - Windows 的默认保留卷是 R 卷。
    - Linux 的默认保留卷是 /mnt/retention。
- 如果使用的是现有进程服务器/配置服务器计算机或者是规模或进程服务器/主目标服务器计算机，则必须添加新驱动器。 新驱动器必须满足上述要求。 如果保留驱动器不存在，则它不会显示在门户上的选择下拉列表中。 将驱动器添加到本地主目标后，该驱动器最多将需要 15 分钟才会显示在门户上的选择项中。 如果 15 分钟后未显示该驱动器，还可以刷新配置服务器。
- 在主目标服务器上安装 VMware 工具或 open-vm-tools。 没有这些工具，将无法检测主目标的 ESXi 主机上的数据存储。
- 在 VMware 中的主目标虚拟机的配置参数中设置 `disk.EnableUUID=true` 设置。 如果此行不存在，请添加此行。 若要为 VMDK 提供一致的 UUID，以便能够正确进行装载，则此设置是必需的。
- 在其上创建了主目标的 ESX 主机必须至少附加了一个虚拟机文件系统 (VMFS) 数据存储。 如果未附加任何 VMFS 数据存储，则重新保护页上的“数据存储”输入为空，因此无法继续操作。 
- 主目标服务器在磁盘上不能有任何快照。 如果具有快照，则重新保护和故障回复会失败。
- 主目标不能有半虚拟化 SCSI 控制器。 控制器只能是 LSI 逻辑控制器。 如果没有 LSI 逻辑控制器，重新保护会失败。
- 不管什么实例，主目标最多可以附加 60 个磁盘。 如果正在重新保护到本地主目标的虚拟机的磁盘总数超过 60，则重新保护到主目标会失败。 确保有足够的主目标的磁盘槽或部署更多的主目标服务器。
    

## <a name="enable-reprotection"></a>启用重新保护

虚拟机在 Azure 中启动后，会留出一段时间让代理重新注册到配置服务器（最多 15 分钟）。 在此期间，将无法进行重新保护并会返回一条错误消息，指出未安装代理。 如果发生这种情况，请等待几分钟，然后重试重新保护：


1. 选择“保管库”   >   “复制的项”。 右键单击已故障转移的虚拟机，然后选择“重新保护”。  也可以从命令按钮中选择该计算机，然后选择“重新保护”。 
2. 验证是否选择了“从 Azure 到本地”保护方向。 
3. 在“主目标服务器”和“进程服务器”中，选择本地主目标服务器和进程服务器。    
4. 对于“数据存储”，选择要将本地磁盘恢复到的数据存储。  删除本地虚拟机后，如果需要创建新磁盘，可使用此选项。 如果磁盘已存在，则会忽略此选项。 仍需指定一个值。
5. 选择保留驱动器。
6. 将自动选择故障回复策略。
7. 选择“确定”开始重新保护。  一个作业会开始将虚拟机从 Azure 复制到本地站点。 可以在“**作业**”选项卡上跟踪进度。重新保护成功后，虚拟机进入受保护状态。

请注意以下信息：
- 如果要恢复到备用位置（删除了本地虚拟机时），请选择针对主目标服务器配置的保留驱动器和数据存储。 故障回复到本地站点时，故障回复保护计划中的 VMware 虚拟机将使用与主目标服务器相同的数据存储。 将在 vCenter 中创建一个新虚拟机。
- 如果要将 Azure 中的虚拟机恢复到现有本地虚拟机，则应在主目标服务器的 ESXi 主机上使用读/写访问权限装载本地虚拟机的数据存储。

    ![“重新保护”对话框](./media/vmware-azure-reprotect/reprotectinputs.png)

- 也可以在恢复计划级别重新保护。 只能通过恢复计划重新保护复制组。 使用恢复计划重新保护时，必须为每台受保护的计算机提供值。
- 请使用同一台主目标服务器来重新保护复制组。 如果使用不同的主目标服务器来重新保护复制组，则服务器无法提供共同的时间点。
- 在重新保护期间，本地虚拟机将关闭。 这有助于确保复制期间的数据一致性。 重新保护完成后，请勿打开虚拟机。



## <a name="common-issues"></a>常见问题

- 如果执行只读的用户 vCenter 发现并保护虚拟机，保护会成功且故障转移可正常工作。 进行重新保护期间，操作会失败，因为无法发现数据存储。 症状是在重新保护期间数据存储没有列出。 若要解决此问题，可以使用具有适当权限的帐户更新 vCenter 凭据，然后重试该作业。 
- 在故障回复 Linux 虚拟机并在本地运行它时，会看到网络管理器程序包已从该计算机卸载。 发生此卸载的原因是虚拟机在 Azure 中恢复时，网络管理器程序包遭到删除。
- 当 Linux 虚拟机配置有静态 IP 地址且故障转移到 Azure 时，将通过 DHCP 获取 IP 地址。 当故障转移回复到本地时，该虚拟机会继续使用 DHCP 获取 IP 地址。 如有需要，请手动登录到该计算机，然后将 IP 地址设置回静态地址。 Windows 虚拟机可以重新获取其静态 IP 地址。
- 如果使用 ESXi 5.5 免费版或 vSphere 6 虚拟机监控程序免费版，则故障转移会成功，但故障回复不会成功。 要启用故障回复，请升级为程序的评估许可证。
- 如果无法从进程服务器访问配置服务器，请使用 Telnet 在端口 443 上检查与配置服务器的连接。 也可以尝试从进程服务器 ping 配置服务器。 连接到配置服务器后，进程服务器也应会发出检测信号。
- 作为物理本地服务器保护的 Windows Server 2008 R2 SP1 服务器无法从 Azure 故障回复到本地站点。
- 在以下情况下无法进行故障回复：
    - 已将计算机迁移到 Azure。 [了解详细信息](migrate-overview.md#what-do-we-mean-by-migration)。
    - 已将 VM 移到另一个资源组。
    - 已删除 Azure VM。
    - 已对 VM 禁用保护。
    - 在 Azure 中手动创建了 VM。 计算机在受到重新保护之前，应该已在本地受到初始保护并故障转移到 Azure。
    - 只能故障回复到 ESXi 主机。 不能将 VMware VM 或物理服务器故障回复到 Hyper-V 主机、物理计算机或 VMware 工作站。


## <a name="next-steps"></a>后续步骤

虚拟机进入受保护状态后，可以[启动故障回复](vmware-azure-failback.md)。 故障回复会关闭 Azure 中的虚拟机，并启动本地虚拟机。 应用程序应该会停机一段时间。 请在应用程序可以容许停机时选择一个时间进行故障回复。


