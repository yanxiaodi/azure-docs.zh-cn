---
title: 在 Hyper-v VM 发生灾难时运行从 Azure 到本地的故障回复 | Microsoft Docs
description: 了解在执行到 Azure 的灾难恢复期间如何使用 Azure Site Recovery 服务将 Hyper-V VM 故障回复到本地站点。
services: site-recovery
author: rajani-janaki-ram
manager: gauravd
ms.service: site-recovery
ms.topic: article
ms.date: 09/12/2019
ms.author: rajanaki
ms.openlocfilehash: 07ecc8547ab155600bccfd1ad8f1ecbb58a18fa3
ms.sourcegitcommit: f3f4ec75b74124c2b4e827c29b49ae6b94adbbb7
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/12/2019
ms.locfileid: "70931848"
---
# <a name="run-a-failback-for-hyper-v-vms"></a>为 Hyper-V VM 运行故障回复

本文介绍了如何对由 Site Recovery 保护的 Hyper-V 虚拟机进行故障回复。

## <a name="prerequisites"></a>先决条件

- 确保你已阅读有关[不同类型的故障回复](concepts-types-of-failback.md)和相应注意事项的详细信息。
- 确保主站点 VMM 服务器或 Hyper-V 主机服务器已连接到 Azure。
- 应当已在虚拟机上执行了**提交**。
- 请确保使用存储帐户进行复制，而不是托管磁盘。 不支持使用管理磁盘复制的 Hyper-v Vm 的故障回复。

## <a name="perform-failback"></a>执行故障回复
从主要位置故障转移到辅助位置后，复制的虚拟机不受 Site Recovery 的保护，辅助位置现在充当活动位置。 要在恢复计划中对 VM 进行故障回复，请运行从辅助站点到主站点的计划内故障回复，如下所述。 
1. 选择“**恢复计划**” > “*recoveryplan_name*”。 单击“**故障转移**” > “**计划的故障转移**”。
2. 在“确认计划的故障转移”页上，选择源和目标位置。 请注意故障转移方向。 如果从主要位置故障转移已按预期完成，并且所有虚拟机都位于辅助位置，则本部分仅供参考。
3. 如果要从 Azure 故障回复，请在“**数据同步**”中选择设置：
    - **在故障转移之前同步数据（仅同步增量更改）** - 此选项可最大程度地减少虚拟机的停机时间，因为它可在不关闭虚拟机的情况下执行同步。 此选项将执行以下步骤：
        - 阶段 1：在 Azure 中生成虚拟机的快照，并将快照复制到本地 Hyper-V 主机。 计算机将继续在 Azure 中运行。
        - 阶段 2：在 Azure 中关闭虚拟机，使其中不会发生任何新的更改。 最终的增量更改集将传输到本地服务器，本地虚拟机会启动。

    - **仅在故障转移期间同步数据(完整下载)** - 此选项速度更快。
        - 此选项速度更快，因为我们预计磁盘的大部分已经更改，而且不想花时间进行校验和计算。 此选项会执行磁盘的下载。 如果已删除本地虚拟机，此选项也很有帮助。
        - 如果已在 Azure 上运行了一段时间（一个月或以上）或已删除本地虚拟机，我们建议使用此选项。 此选项不会执行任何校验和计算。


4. 如果为云启用了数据加密，请在“加密密钥”中选择你在 VMM 服务器上安装提供者期间启用数据加密时颁发的证书。
5. 启动故障转移。 可以在“**作业**”选项卡上跟踪故障转移进度。
6. 如果选择了在故障转移之前同步数据的选项，请在完成初始数据同步并且已准备好在 Azure 中关闭虚拟机后，单击“作业”> 作业名称 >“完成故障转移”。 这会关闭 Azure 计算机，将最新更改传输到本地虚拟机，然后启动本地虚拟机。
7. 现在，可以登录到虚拟机，以验证是否可以按预期使用它。
8. 虚拟机处于待提交状态。 单击“提交”提交故障转移。
9. 若要完成故障回复，请单击“反向复制”以开始保护主站点中的虚拟机。


请遵循以下过程故障回复到原始主站点。 本过程描述如何对恢复计划运行计划的故障转移。 或者，也可以在“**虚拟机**”选项卡上对单个虚拟机运行故障转移。


## <a name="failback-to-an-alternate-location-in-hyper-v-environment"></a>在 Hyper-V 环境中故障回复到备用位置
如果在 [Hyper-V 站点与 Azure](site-recovery-hyper-v-site-to-azure.md) 之间部署了保护，则可以从 Azure 故障回复到备用本地位置。 如果需要设置新的本地硬件，此功能将十分有用。 下面介绍了操作方法。

1. 如果需要设置新的硬件，请在服务器上安装 Windows Server 2012 R2 和 Hyper-V 角色。
2. 创建与原始服务器上的名称相同的虚拟网络交换机。
3. 选择 "**受保护的项** -> "**保护组** -> \<ProtectionGroupName >-> \<VirtualMachineName > 要进行故障回复，然后选择 "计划的**故障转移**"。
4. 在“**确认计划的故障转移**”中，选择“**如果本地虚拟机不存在，则创建它**”。
5. 在“主机名”中，选择要在其上放置虚拟机的新 Hyper-V 主机服务器。
6. 在“数据同步”中，建议选择“在故障转移之前同步数据”这一选项。 此选项可以最大程度地减少虚拟机的停机时间，因为它可以在不关闭虚拟机的情况下执行同步。 此选项将执行以下操作：

    - 阶段 1：在 Azure 中生成虚拟机的快照，并将快照复制到本地 Hyper-V 主机。 计算机将继续在 Azure 中运行。
    - 阶段 2：在 Azure 中关闭虚拟机，使其中不会发生任何新的更改。 最终的更改集将传输到本地服务器，本地虚拟机会启动。
    
7. 单击复选标记开始故障转移（故障回复）。
8. 初始同步完成并且已准备好在 Azure 中关闭虚拟机后，请单击 "**作业** > \<计划的故障转移作业 > >"**完成故障转移**"。 这会关闭 Azure 计算机，将最新更改传输到本地虚拟机，然后启动虚拟机。
9. 可以登录到本地虚拟机，以验证一切是否如你所愿。 然后单击“提交”完成故障转移。 提交会删除 Azure 虚拟机及其磁盘，并准备要再次保护的 VM。
10. 单击“**反向复制**”开始保护本地虚拟机。

    > [!NOTE]
    > 如果在“数据同步”步骤中取消故障回复作业，则本地 VM 将处于损坏状态。 这是因为数据同步将 Azure VM 磁盘中的最新数据复制到本地数据磁盘上，在同步完成之前，磁盘数据并不处于一致状态。 如果在取消数据同步后启动本地 VM，则它可能无法启动。 重新触发故障转移以完成数据同步。


## <a name="why-is-there-no-button-called-failback"></a>为何没有名为故障回复的按钮？
在门户上，没有名为故障回复的显式手势。 故障回复是一个用来复原到主站点的步骤。 根据定义，故障回复是指将虚拟机从恢复站点故障转移回主站点。

启动故障转移时，边栏选项卡会显示有关虚拟机移动方向的信息，如果方向是从 Azure 到本地，则这是故障回复。

## <a name="why-is-there-only-a-planned-failover-gesture-to-failback"></a>为何只有一个已计划的故障转移手势可用来进行故障回复？
Azure 是具有高可用性的环境，虚拟机将始终可用。 故障回复是一个已计划活动，在该活动中，决定进行短暂的停机以便工作负荷可以重新开始在本地运行。 这应当没有数据丢失。 因此，只有一个已计划的故障转移手势可用，这会关闭 Azure 中的 VM，下载最新更改并确保没有数据丢失。

## <a name="do-i-need-a-process-server-in-azure-to-failback-to-hyper-v"></a>Hyper-v 的故障回复是否需要在 Azure 中使用进程服务器？
不。仅当保护 VMware 虚拟机时才需要进程服务器。 Hyper-v 虚拟机的保护/故障回复均不需要部署任何其他组件。


## <a name="time-taken-to-failback"></a>故障回复所需时间
完成数据同步及启动虚拟机所需的时间取决于各种因素。 为了深入了解所需时间，我们需要解释数据同步期间发生的情况。

数据同步会为虚拟机磁盘拍摄快照，然后开始逐块检查并计算其校验和。 计算出的检验和将发送到本地，然后与相同块的本地校验和进行比较。 如果校验和匹配，则不会传输数据块。 如果不匹配，则会将数据块传输到本地。 此传输时间取决于可用带宽。 校验和的速度为每分钟几 GB。 

要加快数据下载速度，可将 MARS 代理配置为使用多个线程并行下载。 要了解如何更改代理中的下载线程，请参阅[此文档](https://support.microsoft.com/en-us/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage)。


## <a name="next-steps"></a>后续步骤

在**提交**后，可以启动*反向复制*。 这会通过从本地复制回 Azure 的方式开始保护虚拟机。 这只会复制在 Azure 中关闭 VM 后发生的更改，因此只会发送差异更改。
